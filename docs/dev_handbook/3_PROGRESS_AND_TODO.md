# 进度与待办

本章记录当前交付成果、测试状态以及后续工作规划，便于新成员快速对齐开发脉络。

## 1. 当前进展快照（截至 2025-10-05）

### 1.1 核心功能

| 模块 | 状态 | 说明 |
| ---- | ---- | ---- |
| 仿真调度器 (`SimulationOrchestrator`) | ✅ 已上线 | 支持单 Tick、批量推进、仿真重置与删除 |
| 数据访问层 (`DataAccessLayer`) | ✅ 已上线 | Redis 封装完善，覆盖参与者登记、Tick 日志、状态更新 |
| 用户脚本引擎 | ✅ 已上线 | 支持 Python 脚本上传、沙箱执行、覆盖决策合并 |
| 脚本持久化 (PostgreSQL) | ✅ 新增 | 支持脚本先入库后挂载、自动建表与索引 |
| Web 仪表盘 | ✅ 已上线 | 仿真状态展示、脚本上传/挂载、管理员管理入口 |
| 认证与授权 | ✅ 已上线 | 注册、登录、Token 校验、角色区分 |
| Docker 化 | ✅ 已上线 | `docker-compose.yml` 启动 FastAPI + Postgres + Redis |

### 1.2 自动化保障

| 项目 | 状态 | 备注 |
| ---- | ---- | ---- |
| `pytest` 覆盖 | ✅ 25 项全部通过 | 包含脚本生命周期、仿真流程、认证用例 |
| 开发脚本 | ✅ `scripts/dev_start.sh` | 自动检测 Docker、加载 `config/dev.env` |
| 文档 | ✅ README + 开发者手册 | 同步记录架构、数据、进度 |

## 2. 近期交付内容

| 主题 | 亮点 |
| ---- | ---- |
| 脚本库重构 | “先上传后挂载” 工作流、个人脚本库 API `/scripts`、仪表盘挂载入口 |
| 数据持久化加强 | PostgreSQL schema 自愈、脚本解绑保留、Redis 操作统一封装 |
| 文档体系 | README 扩展、`docs/dev_handbook/` 手册、Mermaid 数据图 |

## 3. 待办事项

### 3.1 高优先级（短期）

1. **脚本执行资源控制**：限定 CPU/内存/执行时间，避免脚本阻塞事件循环，可结合 `asyncio.wait_for` 与受限线程池。
2. **脚本版本比对与回滚**：补充版本 Diff / 历史列表 API，实现一键回滚。
3. **API 速率限制**：对 `run_tick`、`/scripts` 等关键端点增加速率限制或配额。

### 3.2 中期规划

1. **指标监控与告警**：暴露 Prometheus 指标（Tick 耗时、脚本异常计数），集成告警。
2. **脚本多仿真复用体验**：支持脚本克隆、参数化挂载，Web UI 增加搜索筛选。
3. **仿真快照导出**：`GET /simulations/{id}/snapshot` 导出 JSON/Parquet，方便离线分析。
4. **权限模型扩展**：从“admin/非 admin”扩展到讲师/学生/访客等角色。

### 3.3 长期展望

1. **弹性部署**：拆分 API 与 Worker 进程，引入消息队列处理长任务，支持多实例并行。
2. **实时可视化**：使用 WebSocket 推送 Tick 日志、市场价格，实现前端实时仪表盘。
3. **经济模型扩展**：引入更多市场、政策模块，丰富 `logic_modules/`。

## 4. 协作建议

- **代码审查重点**：跨层接口（尤其 `data_access` 与 `script_engine`）的改动需同步测试与文档。
- **Issue 管理**：为“脚本资源限制”“监控告警”等议题拆分 Issue，便于跟踪。
- **文档共建**：合并 PR 时更新本手册，保持知识同步。

如需扩展本清单，请直接修改本文件或在 PR 中留下说明。
