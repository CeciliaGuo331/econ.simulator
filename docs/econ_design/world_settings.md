# **经济仿真引擎 架构设计**

## **1. 引言与设计目标**

**1.1. 项目定位:**
本引擎旨在构建一个离散时间下的、多代理人（Multi-Agent）宏观经济仿真平台。其核心应用场景是作为一门宏观经济学相关课程的教学与实验平台，允许学生（玩家）通过编写或配置个体策略（Agent Strategy）来参与、影响并观察虚拟经济的动态演化。

**1.2. 核心设计原则:**
* **模块化 (Modularity):** 引擎核心逻辑与个体策略逻辑必须严格分离，通过清晰的API进行交互。
* **可扩展性 (Extensibility):** 架构应支持未来方便地增加新的代理人类型、市场机制或经济冲击。
* **可观测性 (Observability):** 系统的所有状态和数据都应易于记录、查询和可视化，为教学和分析提供支持。
* **确定性与可复现性 (Determinism & Reproducibility):** 在给定相同的初始条件和策略下，仿真结果应是可复现的（在不使用外部随机API如LLM的情况下）。

## **2. 系统架构分层**

本引擎建议采用分层架构，以实现关注点分离，提高系统的健壮性和灵活性。

* **第四层：策略/API层 (Strategy/API Layer)**
    * **描述:** 这是完全暴露给“玩家”的层面。玩家在此编写、配置或接入其代理人的决策逻辑。
    * **实现:** 可以是Python脚本、JSON配置文件，或封装了LLM API调用的模块。
    * **交互:** 引擎通过标准化的API从此层获取每个代理人的“决策”输出。

* **第三层：代理人层 (Agent Layer)**
    * **描述:** 仿真世界中所有独立个体的集合。每个代理人实例都包含其完整的“状态（State）”数据，并执行从策略层获取的“决策（Decision）”。
    * **核心:** 管理大量的个人、企业、银行等实例的生命周期和状态数据。

* **第二层：市场与环境层 (Market & Environment Layer)**
    * **描述:** 这是代理人之间发生交互的“公共空间”。它不包含任何代理人，而是定义了交互的规则和结算的机制。
    * **组件:**
        * `商品市场 (Goods Market)`: 负责商品交易、价格发现。
        * `劳动力市场 (Labor Market)`: 负责职位发布、求职匹配、工资决定。
        * `金融市场 (Financial Market)`: 负责存贷款、债券发行与交易。
        * `宏观数据中心 (Macro Data Center)`: 负责计算和发布所有宏观经济指标。

* **第一层：核心引擎层 (Core Engine Layer)**
    * **描述:** 系统的心脏引擎。
    * **职责:**
        * `主事件循环 (Main Event Loop)`: 驱动仿真时间按“Tick”前进。
        * `时序调度器 (Scheduler)`: 严格规定在一个Tick内，各个层和模块的计算顺序。
        * `规则执行官 (Rule Enforcer)`: 确保所有代理人的行为都符合其“限制（Constraints）”。
        * `数据记录器 (Logger)`: 记录所有状态和事件，用于事后分析。

## **3. 时间与事件循环机制**

根据“**离散时间、每天运行三次独立事件循环**”的核心设定，我们定义如下时间结构：

*   **纪元 (Epoch):** 一次完整的仿真运行。
*   **天 (Day):** 宏观经济数据发布的基本周期。
*   **时刻 (Tick):** 引擎事件循环的最小单位，**每天分为N个Ticks**（例如，早晨、下午、夜晚）。每个Tick都会执行一次完整且结构相同的事件循环。

**标准事件循环 (Standard Event Loop) - 每日重复三次:**

为了保证因果关系的清晰（例如，生产必须先于交易），一个标准的事件循环（Tick）内部包含以下顺序执行的阶段。这个流程在一天内会重复三次。

1.  **计划阶段**
    *   所有代理人（个人、企业、商业银行、央行、政府）观察当前状态和市场数据，制定本Tick的行动计划（如生产量、消费量、招聘需求等）。

2.  **生产与分配阶段**
    *   企业根据计划进行生产，**产品进入库存**。
    *   若满足支付条件，企业向雇员支付工资，**更新被雇佣家户和企业的现金**。

3.  **市场交易阶段**
    *   **劳动力市场:** 企业发布岗位，个人求职。随机匹配。
    *   **商品市场:** 个人消费，企业出售商品。集合竞价，价优者得。
    *   **金融市场:** 个人储蓄，企业贷款。
    *   本阶段每个市场交易完成后都要进行一次状态更新，再到下一个市场。

## **4. 代理人策略API与LLM集成设想**

* **API设计:** 引擎在需要代理人决策时，会调用一个标准化的函数，例如：
    `decision_object = player_strategy.get_decision(agent_state, market_data)`
    * `agent_state`: 该代理人可见的**私有**状态。
    * `market_data`: 该代理人可见的**公开**市场数据。

* **玩家的实现方式:**
    1.  **传统编程:** 玩家使用Python等语言，编写包含经济学逻辑的`if-else`和算法代码。
    2.  **LLM集成:** 玩家的`get_decision`函数内部调用大语言模型以辅助决策。具体流程例如:
        a.  将`agent_state`和`market_data`组合并**格式化**成一段给LLM的自然语言提示（Prompt）。
        b.  通过API**调用**一个大型语言模型（如GPT系列）。
        c.  **解析**LLM返回的自然语言回答，将其转换成引擎可以理解的、结构化的`decision_object`。

* **需注意的挑战:**
    * **性能与成本:** 大量代理人频繁调用LLM API会带来显著的时间延迟和费用成本。每日的tick数量需要调试后得出结论。
    * **稳定性与可复现性:** LLM的回答具有随机性，可能导致仿真结果难以复现。同时，返回格式的不稳定也可能导致解析失败。
    * **“黑箱”行为:** 难以精确解释为什么LLM会做出某个特定的经济决策。
