{% extends "base.html" %}
{% from "partials/state_macros.html" import fmt_number, render_table, render_households_table %}
{% block title %}仪表盘 - Econ Simulator{% endblock %}
{% block content %}
    {% set entity_map = entity_display_map if entity_display_map is defined else {} %}
    {% set _tab = (active_tab if active_tab is defined and active_tab else 'overview') %}
    <nav class="tabs">
        {% set _base = '/web/dashboard' %}
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=overview" class="tab{% if _tab == 'overview' %} active{% endif %}">总览</a>
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=scripts" class="tab{% if _tab == 'scripts' %} active{% endif %}">脚本</a>
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=upload" class="tab{% if _tab == 'upload' %} active{% endif %}">上传/挂载</a>
        {% if simulation_id %}
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=rotate" class="tab{% if _tab == 'rotate' %} active{% endif %}">日终轮换</a>
        {% endif %}
    </nav>
    <section class="panel">
        <h2>欢迎，{{ user.email }}（{{ user.user_type }}）</h2>
        <p>
            当前仿真世界：<strong>{{ simulation_id or "未选择" }}</strong>
        </p>
        {% if simulation_id %}
            <p>
                当前脚本上限：
                {% if script_limit is not none %}
                    <strong>{{ script_limit }}</strong> 个脚本 / 用户
                {% elif default_script_limit is not none %}
                    <strong>{{ default_script_limit }}</strong> 个脚本 / 用户（默认）
                {% else %}
                    <strong>无限制</strong>
                {% endif %}
            </p>
        {% elif default_script_limit is not none %}
            <p>
                默认脚本上限：<strong>{{ default_script_limit }}</strong> 个脚本 / 用户
            </p>
        {% endif %}
        {% if message %}<div class="status success">{{ message }}</div>{% endif %}
        {% if error %}<div class="error">{{ error }}</div>{% endif %}
    </section>
    {% if log_download_url and _tab == 'overview' %}
        <section class="panel">
            <h3>调试工具</h3>
            <p>可通过下方链接下载最近的执行日志（最多保留 1000 条），帮助定位脚本报错与经济状态变化。</p>
            <p>
                <a class="button" href="{{ log_download_url }}">下载最近日志</a>
            </p>
        </section>
    {% endif %}
    {% if user.user_type != "admin" and _tab == 'overview' %}
        <section class="panel">
            <h3>查看仿真世界</h3>
            {% if all_simulations %}
                <form method="post" action="/web/simulations/join" class="join-form">
                    <label class="join-field" for="simulation-select">
                        <span class="join-label">选择仿真世界</span>
                        <select id="simulation-select" name="simulation_id">
                            {% for sid in all_simulations %}
                                <option value="{{ sid }}"{% if sid == simulation_id %} selected{% endif %}>{{ sid }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <button type="submit" class="button">切换</button>
                </form>
            {% else %}
                <p class="empty">暂无可查看的仿真世界，请稍后再试或联系管理员。</p>
            {% endif %}
        </section>
    {% endif %}
    {% if _tab == 'overview' %}
    <section class="grid">
        <article class="card">
            <h3>角色视角数据</h3>
            <div class="scroll-pane role-state">
                {% set role_state = context.role_state if context.role_state is defined else None %}
                {% if role_state %}
                    {% if role_state.role == "individual" %}
                        <div class="state-block">
                            <h4>宏观指标</h4>
                            {{ render_table(role_state.macro_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>市场价格与利率</h4>
                            {{ render_table(role_state.market_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>家户平均指标</h4>
                            {{ render_table(role_state.household_rows) }}
                        </div>
                    {% elif role_state.role == "firm" %}
                        <div class="state-block">
                            <h4>宏观指标</h4>
                            {{ render_table(role_state.macro_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>企业经营概览</h4>
                            {{ render_table(role_state.agent_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>劳动力市场</h4>
                            {{ render_table(role_state.labor_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>金融环境</h4>
                            {{ render_table(role_state.finance_rows) }}
                        </div>
                    {% elif role_state.role == "government" %}
                        <div class="state-block">
                            <h4>宏观指标</h4>
                            {{ render_table(role_state.macro_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>财政收支</h4>
                            {{ render_table(role_state.fiscal_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>劳动力市场</h4>
                            {{ render_table(role_state.labor_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>金融环境</h4>
                            {{ render_table(role_state.finance_rows) }}
                        </div>
                    {% elif role_state.role == "commercial_bank" %}
                        <div class="state-block">
                            <h4>宏观指标</h4>
                            {{ render_table(role_state.macro_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>银行资产负债表</h4>
                            {{ render_table(role_state.bank_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>政策与利率</h4>
                            {{ render_table(role_state.policy_rows) }}
                        </div>
                    {% elif role_state.role == "central_bank" %}
                        <div class="state-block">
                            <h4>宏观指标</h4>
                            {{ render_table(role_state.macro_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>政策设定</h4>
                            {{ render_table(role_state.policy_rows) }}
                        </div>
                        <div class="state-block">
                            <h4>银行体系</h4>
                            {{ render_table(role_state.banking_rows) }}
                        </div>
                    {% else %}
                        {% set world_view = role_state.world if role_state.world is defined else context.world if context.world is defined else context %}
                        {% if world_view %}
                            <div class="state-block">
                                <h4>世界概览</h4>
                                {{ render_table([
                                                                ("当前 Tick", world_view.tick if world_view.tick is defined else None, True) ,
                                ("当前日", world_view.day if world_view.day is defined else None, True),
                                ("家户数量", world_view.households | length if world_view.households is defined else 0, True)
                                ]) }}
                            </div>
                            {% if world_view.macro is defined %}
                                <div class="state-block">
                                    <h4>宏观指标</h4>
                                    {{ render_table([
                                                                        ("GDP", world_view.macro.gdp) ,
                                    ("通胀率", world_view.macro.inflation),
                                    ("失业率", world_view.macro.unemployment_rate)
                                    ]) }}
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% else %}
                    <p class="empty">当前没有可展示的数据。</p>
                {% endif %}
            </div>
        </article>
        <article class="card">
            <h3>当前仿真世界脚本</h3>
            {% if simulation_id and scripts %}
                <div class="scroll-pane">
                    <ul class="script-list">
                        {% for script in scripts %}
                            <li>
                                <div class="script-item">
                                    <div class="script-detail">
                                        <span class="label">上传者</span>
                                        <span class="value">{{ script.user_id }}</span>
                                        <span class="label">上传时间</span>
                                        <span class="value">{{ script.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</span>
                                        <span class="label">脚本 ID</span>
                                        <span class="value">{{ script.script_id }}</span>
                                        <span class="label">主体类型</span>
                                        <span class="value">{{ script.agent_kind.value }}</span>
                                        <span class="label">实体 ID</span>
                                        <span class="value">{{ entity_map.get(script.script_id, script.entity_id) }}</span>
                                        <span class="label">版本</span>
                                        <span class="value">{{ script.code_version }}</span>
                                    </div>
                                    {% if script.description %}
                                        <p class="script-desc">{{ script.description }}</p>
                                    {% else %}
                                        <p class="script-desc empty">（无描述）</p>
                                    {% endif %}
                                </div>
                                {% if user.user_type != "admin" and script.user_id == user.email %}
                                    {% set allow_detach = current_simulation_tick == 0 %}
                                    <div class="script-actions">
                                        <form method="post"
                                              action="/web/scripts/detach"
                                              class="script-action-form inline-form">
                                            <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                            <input type="hidden" name="simulation_id" value="{{ simulation_id }}">
                                            <input type="hidden"
                                                   name="current_simulation_id"
                                                   value="{{ simulation_id }}">
                                            <button type="submit"
                                                    class="danger"
                                                    {% if not allow_detach %}disabled{% endif %}>取消挂载</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% elif simulation_id %}
                <div class="scroll-pane">
                    <p class="empty">尚未有脚本挂载。</p>
                </div>
            {% else %}
                <p class="empty">请选择或加入仿真世界后查看脚本列表。</p>
            {% endif %}
        </article>
        <article class="card">
            <h3>个人脚本库</h3>
            {% if user_scripts %}
                <div class="scroll-pane">
                    <ul class="script-list">
                        {% for script in user_scripts %}
                            <li>
                                <div class="script-item">
                                    <div class="script-detail">
                                        <span class="label">上传时间</span>
                                        <span class="value">{{ script.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</span>
                                        <span class="label">上传者</span>
                                        <span class="value">{{ script.user_id }}</span>
                                        <span class="label">脚本 ID</span>
                                        <span class="value">{{ script.script_id }}</span>
                                        <span class="label">主体类型</span>
                                        <span class="value">{{ script.agent_kind.value }}</span>
                                        <span class="label">实体 ID</span>
                                        <span class="value">{{ entity_map.get(script.script_id, script.entity_id) }}</span>
                                        <span class="label">版本</span>
                                        <span class="value">{{ script.code_version }}</span>
                                        <span class="label">状态</span>
                                        <span class="value">
                                            {% if script.simulation_id %}
                                                已挂载至 {{ script.simulation_id }}
                                            {% else %}
                                                未挂载
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% if script.description %}
                                        <p class="script-desc">{{ script.description }}</p>
                                    {% else %}
                                        <p class="script-desc empty">（无描述）</p>
                                    {% endif %}
                                </div>
                                {% set script_tick = script_tick_map.get(script.simulation_id) %}
                                {% set detach_enabled = script.simulation_id and script_tick == 0 %}
                                {% set delete_enabled = (script.simulation_id is none) or (script_tick is none) or (script_tick == 0) %}
                                <div class="script-actions">
                                    <form method="post"
                                          action="/web/scripts/delete"
                                          class="script-action-form inline-form">
                                        <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                        <input type="hidden"
                                               name="current_simulation_id"
                                               value="{{ simulation_id }}">
                                        <button type="submit"
                                                class="danger"
                                                {% if not delete_enabled %}disabled{% endif %}>删除脚本</button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if _tab == 'scripts' %}
                <section class="panel">
                    <h3>当前仿真世界脚本</h3>
                    {% if simulation_id and scripts %}
                        <div class="scroll-pane">
                            <ul class="script-list">
                                {% for script in scripts %}
                                    <li>
                                        <div class="script-item">
                                            <div class="script-detail">
                                                <span class="label">上传者</span>
                                                <span class="value">{{ script.user_id }}</span>
                                                <span class="label">上传时间</span>
                                                <span class="value">{{ script.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</span>
                                                <span class="label">脚本 ID</span>
                                                <span class="value">{{ script.script_id }}</span>
                                                <span class="label">主体类型</span>
                                                <span class="value">{{ script.agent_kind.value }}</span>
                                                <span class="label">实体 ID</span>
                                                <span class="value">{{ entity_map.get(script.script_id, script.entity_id) }}</span>
                                                <span class="label">版本</span>
                                                <span class="value">{{ script.code_version }}</span>
                                            </div>
                                            {% if script.description %}
                                                <p class="script-desc">{{ script.description }}</p>
                                            {% else %}
                                                <p class="script-desc empty">（无描述）</p>
                                            {% endif %}
                                        </div>
                                        {% if user.user_type != "admin" and script.user_id == user.email %}
                                            {% set allow_detach = current_simulation_tick == 0 %}
                                            <div class="script-actions">
                                                <form method="post"
                                                      action="/web/scripts/detach"
                                                      class="script-action-form inline-form">
                                                    <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                                    <input type="hidden" name="simulation_id" value="{{ simulation_id }}">
                                                    <input type="hidden"
                                                           name="current_simulation_id"
                                                           value="{{ simulation_id }}">
                                                    <button type="submit"
                                                            class="danger"
                                                            {% if not allow_detach %}disabled{% endif %}>取消挂载</button>
                                                </form>
                                            </div>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif simulation_id %}
                        <div class="scroll-pane">
                            <p class="empty">尚未有脚本挂载。</p>
                        </div>
                    {% else %}
                        <p class="empty">请选择或加入仿真世界后查看脚本列表。</p>
                    {% endif %}
                </section>
                <section class="panel">
                    <h3>个人脚本库</h3>
                    {% if user_scripts %}
                        <div class="scroll-pane">
                            <ul class="script-list">
                                {% for script in user_scripts %}
                                    <li>
                                        <div class="script-item">
                                            <div class="script-detail">
                                                <span class="label">上传时间</span>
                                                <span class="value">{{ script.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</span>
                                                <span class="label">上传者</span>
                                                <span class="value">{{ script.user_id }}</span>
                                                <span class="label">脚本 ID</span>
                                                <span class="value">{{ script.script_id }}</span>
                                                <span class="label">主体类型</span>
                                                <span class="value">{{ script.agent_kind.value }}</span>
                                                <span class="label">实体 ID</span>
                                                <span class="value">{{ entity_map.get(script.script_id, script.entity_id) }}</span>
                                                <span class="label">版本</span>
                                                <span class="value">{{ script.code_version }}</span>
                                                <span class="label">状态</span>
                                                <span class="value">
                                                    {% if script.simulation_id %}
                                                        已挂载至 {{ script.simulation_id }}
                                                    {% else %}
                                                        未挂载
                                                    {% endif %}
                                                </span>
                                            </div>
                                            {% if script.description %}
                                                <p class="script-desc">{{ script.description }}</p>
                                            {% else %}
                                                <p class="script-desc empty">（无描述）</p>
                                            {% endif %}
                                        </div>
                                        {% set script_tick = script_tick_map.get(script.simulation_id) %}
                                        {% set detach_enabled = script.simulation_id and script_tick == 0 %}
                                        {% set delete_enabled = (script.simulation_id is none) or (script_tick is none) or (script_tick == 0) %}
                                        <div class="script-actions">
                                            <form method="post"
                                                  action="/web/scripts/delete"
                                                  class="script-action-form inline-form">
                                                <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                                <input type="hidden"
                                                       name="current_simulation_id"
                                                       value="{{ simulation_id }}">
                                                <button type="submit"
                                                        class="danger"
                                                        {% if not delete_enabled %}disabled{% endif %}>删除脚本</button>
                                            </form>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% else %}
                        <div class="scroll-pane">
                            <p class="empty">还没有上传任何脚本。</p>
                        </div>
                    {% endif %}
                </section>
                {% endif %}

                {% if _tab == 'upload' %}
                <div class="scroll-pane">
                    <p class="empty">还没有上传任何脚本，下面的表单可将脚本保存到个人脚本库。</p>
                </div>
            {% endif %}
        </article>
    </section>
    <section class="panel">
        <h3>上传脚本</h3>
        {% set script_defaults = script_form_defaults if script_form_defaults is defined else {} %}
        {% set resolved_kind = script_defaults.get('resolved_agent_kind') %}
        {% set agent_kind_labels = {
            "household": "家户（Household）",
            "firm": "企业（Firm）",
            "bank": "商业银行（Bank）",
            "government": "政府（Government）",
            "central_bank": "中央银行（Central Bank）"
        } %}
        <form method="post"
              action="/web/scripts"
              class="script-form"
              enctype="multipart/form-data">
            <input type="hidden"
                   name="current_simulation_id"
                   value="{{ simulation_id }}">
            {% if resolved_kind %}
                <p class="form-hint">
                    目标主体类型：<strong>{{ agent_kind_labels.get(resolved_kind, resolved_kind) }}</strong>（系统已自动识别）
                </p>
            {% else %}
                <p class="error">当前账号未配置可上传的主体类型，请联系管理员。</p>
            {% endif %}
            <p class="form-hint">目标实体 ID 将在挂载脚本时自动生成，无需填写。</p>
            <label>
                脚本说明（可选）
                <input type="text"
                       name="description"
                       placeholder="简单描述脚本用途"
                       value="{{ script_defaults.get('description', '') }}">
            </label>
            <label>
                脚本文件（仅支持 .py 扩展名）
                <input type="file" name="script_file" accept=".py" required>
            </label>
            <p class="form-hint">
                脚本必须定义 <code>generate_decisions(context)</code> 函数。
            </p>
            <p class="form-hint">挂载脚本时系统会自动为主体分配唯一实体 ID。</p>
            <p class="form-hint">若当前尚未加入仿真世界，脚本会先保存到个人脚本库，稍后可在下方挂载。</p>
            {% if simulation_id %}
                <p class="form-hint">
                    当前仿真世界：<strong>{{ simulation_id }}</strong>。新脚本会先保存到个人脚本库，您可以在下方选择挂载到该仿真世界。
                </p>
            {% endif %}
            <button type="submit">提交脚本</button>
        </form>
    </section>
    {% if simulation_id %}
        <section class="panel">
            <h3>挂载已有脚本</h3>
            {% if attachable_scripts %}
                <form method="post" action="/web/scripts/attach" class="script-form">
                    <input type="hidden" name="simulation_id" value="{{ simulation_id }}">
                    <label>
                        选择脚本
                        <select name="script_id">
                            {% for script in attachable_scripts %}
                                <option value="{{ script.script_id }}">
                                    {{ script.script_id }} · {{ script.agent_kind.value }} · ID={{ entity_map.get(script.script_id, script.entity_id) }}
                                    {% if script.description %}· {{ script.description }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                    <p class="form-hint">将脚本挂载到当前仿真世界后，它会立即参与决策逻辑。</p>
                    <button type="submit">挂载脚本</button>
                </form>
            {% else %}
                <p class="empty">个人脚本库暂无未挂载的脚本。</p>
            {% endif %}
        </section>
    {% endif %}
    {% endif %}

    {% if _tab == 'rotate' and simulation_id and scripts %}
        <section class="panel">
            <h3>日终脚本轮换</h3>
            <p class="form-hint">当日所有 Tick 执行完毕（到达日终）后，可替换已挂载脚本的代码，实体状态将被保留，变更在下一交易日生效。</p>
            <form method="post" action="/web/scripts/rotate" class="script-form" enctype="multipart/form-data">
                <input type="hidden" name="simulation_id" value="{{ simulation_id }}">
                <label>
                    选择已挂载脚本
                    <select name="script_id" required>
                        {% for script in scripts if script.user_id == user.email %}
                            <option value="{{ script.script_id }}">
                                {{ script.script_id }} · {{ script.agent_kind.value }} · ID={{ entity_map.get(script.script_id, script.entity_id) }}
                            </option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    新脚本描述（可选）
                    <input type="text" name="new_description" placeholder="本次版本的说明">
                </label>
                <label>
                    新脚本文件（.py）
                    <input type="file" name="script_file" accept=".py" required>
                </label>
                <button type="submit">在日终替换脚本</button>
            </form>
        </section>
    {% endif %}
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const storageKey = "userDashboardScrollY";
    window.history.scrollRestoration = "manual";

    const rememberScroll = () => {
        sessionStorage.setItem(
            storageKey,
            String(window.scrollY || window.pageYOffset || 0)
        );
    };

    const restoreScroll = () => {
        const stored = sessionStorage.getItem(storageKey);
        if (stored !== null) {
            const value = Number(stored);
            if (Number.isFinite(value)) {
                window.scrollTo({ top: value, behavior: "auto" });
            }
            sessionStorage.removeItem(storageKey);
        }
    };

    restoreScroll();

    document.querySelectorAll("form").forEach((form) => {
        form.addEventListener("submit", rememberScroll);
    });

    window.addEventListener("beforeunload", rememberScroll);
});
    </script>
{% endblock %}
