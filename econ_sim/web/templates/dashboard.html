{% extends "base.html" %}
{% from "partials/state_macros.html" import fmt_number, render_table, render_households_table %}
{% block title %}仪表盘 - Econ Simulator{% endblock %}
{% block content %}
    <section class="panel">
        <h2>欢迎，{{ user.email }}（{{ user.user_type }}）</h2>
        <p>
            当前仿真世界：<strong>{{ simulation_id or "未选择" }}</strong>
        </p>
        {% if simulation_id %}
            <p>
                当前脚本上限：
                {% if script_limit is not none %}
                    <strong>{{ script_limit }}</strong> 个脚本 / 用户
                {% elif default_script_limit is not none %}
                    <strong>{{ default_script_limit }}</strong> 个脚本 / 用户（默认）
                {% else %}
                    <strong>无限制</strong>
                {% endif %}
            </p>
        {% elif default_script_limit is not none %}
            <p>
                默认脚本上限：<strong>{{ default_script_limit }}</strong> 个脚本 / 用户
            </p>
        {% endif %}
        {% if message %}<div class="status success">{{ message }}</div>{% endif %}
        {% if error %}<div class="error">{{ error }}</div>{% endif %}
    </section>
    {% if log_download_url %}
        <section class="panel">
            <h3>调试工具</h3>
            <p>可通过下方链接下载最近的执行日志（最多保留 1000 条），帮助定位脚本报错与经济状态变化。</p>
            <p>
                <a class="button" href="{{ log_download_url }}">下载最近日志</a>
            </p>
        </section>
    {% endif %}
    {% if user.user_type != "admin" %}
        <section class="panel">
            <h3>查看仿真世界</h3>
            {% if all_simulations %}
                <form method="post" action="/web/simulations/join" class="join-form">
                    <label class="join-field" for="simulation-select">
                        <span class="join-label">选择仿真世界</span>
                        <select id="simulation-select" name="simulation_id">
                            {% for sid in all_simulations %}
                                <option value="{{ sid }}"{% if sid == simulation_id %} selected{% endif %}>{{ sid }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <button type="submit" class="button">切换</button>
                </form>
            {% else %}
                <p class="empty">暂无可查看的仿真世界，请稍后再试或联系管理员。</p>
            {% endif %}
        </section>
    {% endif %}
    <section class="grid">
        <article class="card">
            <h3>角色视角数据</h3>
            <div class="scroll-pane role-state">
                {% set ns = namespace(rendered=False) %}
                {% if user.user_type == "individual" and context.households %}
                    <h4>家户样本（最多 8 户）</h4>
                    {{ render_households_table(context.households, 8) }}
                    {% set ns.rendered = True %}
                {% elif user.user_type == "firm" and context.firm %}
                    <h4>企业经营概览</h4>
                    {{ render_table([
                        ("产品价格", context.firm.price),
                        ("计划产出", context.firm.planned_production),
                        ("工资报价", context.firm.wage_offer),
                        ("雇员数量", context.firm.employees | length if context.firm.employees is defined else 0, True),
                        ("最近销售额", context.firm.last_sales if context.firm.last_sales is defined else None)
                    ]) }}
                    <h4>资产负债表</h4>
                    {{ render_table([
                        ("现金", context.firm.balance_sheet.cash),
                        ("存款", context.firm.balance_sheet.deposits),
                        ("贷款", context.firm.balance_sheet.loans),
                        ("库存（商品）", context.firm.balance_sheet.inventory_goods)
                    ]) }}
                    {% set ns.rendered = True %}
                {% elif user.user_type == "government" and context.government %}
                    <h4>财政概览</h4>
                    {{ render_table([
                        ("税率", context.government.tax_rate),
                        ("失业救济", context.government.unemployment_benefit),
                        ("财政支出", context.government.spending),
                        ("雇员数量", context.government.employees | length if context.government.employees is defined else 0, True)
                    ]) }}
                    <h4>资产负债表</h4>
                    {{ render_table([
                        ("现金", context.government.balance_sheet.cash),
                        ("存款", context.government.balance_sheet.deposits),
                        ("贷款", context.government.balance_sheet.loans)
                    ]) }}
                    {% set ns.rendered = True %}
                {% elif user.user_type == "commercial_bank" and context.bank %}
                    <h4>银行指标</h4>
                    {{ render_table([
                        ("存款利率", context.bank.deposit_rate),
                        ("贷款利率", context.bank.loan_rate),
                        ("贷款申请数", context.bank.approved_loans | length if context.bank.approved_loans is defined else 0, True)
                    ]) }}
                    <h4>资产负债表</h4>
                    {{ render_table([
                        ("现金", context.bank.balance_sheet.cash),
                        ("存款", context.bank.balance_sheet.deposits),
                        ("贷款发放", context.bank.balance_sheet.loans),
                        ("库存商品", context.bank.balance_sheet.inventory_goods)
                    ]) }}
                    {% set ns.rendered = True %}
                {% elif user.user_type == "central_bank" and context.central_bank %}
                    <h4>央行政策参数</h4>
                    {{ render_table([
                        ("基准利率", context.central_bank.base_rate),
                        ("准备金率", context.central_bank.reserve_ratio),
                        ("通胀目标", context.central_bank.inflation_target),
                        ("失业目标", context.central_bank.unemployment_target)
                    ]) }}
                    {% set ns.rendered = True %}
                {% else %}
                    {% set world_view = context.world if context.world is defined else context %}
                    {% if world_view %}
                        <h4>世界概览</h4>
                        {{ render_table([
                            ("当前 Tick", world_view.tick if world_view.tick is defined else None, True),
                            ("当前日", world_view.day if world_view.day is defined else None, True),
                            ("家户数量", world_view.households | length if world_view.households is defined else 0, True)
                        ]) }}
                        {% if world_view.macro is defined %}
                            <h4>宏观指标</h4>
                            {{ render_table([
                                ("GDP", world_view.macro.gdp),
                                ("通胀率", world_view.macro.inflation),
                                ("失业率", world_view.macro.unemployment_rate)
                            ]) }}
                        {% endif %}
                        {% set ns.rendered = True %}
                    {% endif %}
                {% endif %}
                {% if not ns.rendered %}
                    <p class="empty">当前没有可展示的数据。</p>
                {% endif %}
            </div>
        </article>
        <article class="card">
            <h3>当前仿真世界脚本</h3>
            {% if simulation_id and scripts %}
                <div class="scroll-pane">
                    <ul class="script-list">
                        {% for script in scripts %}
                            <li>
                                <div class="script-item">
                                    <div class="script-detail">
                                        <span class="label">上传者</span>
                                        <span class="value">{{ script.user_id }}</span>
                                        <span class="label">上传时间</span>
                                        <span class="value">{{ script.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</span>
                                        <span class="label">脚本 ID</span>
                                        <span class="value">{{ script.script_id }}</span>
                                        <span class="label">版本</span>
                                        <span class="value">{{ script.code_version }}</span>
                                    </div>
                                    {% if script.description %}
                                        <p class="script-desc">{{ script.description }}</p>
                                    {% else %}
                                        <p class="script-desc empty">（无描述）</p>
                                    {% endif %}
                                </div>
                                {% if user.user_type != "admin" and script.user_id == user.email %}
                                    {% set allow_detach = current_simulation_tick == 0 %}
                                    <div class="script-actions">
                                        <form method="post"
                                              action="/web/scripts/detach"
                                              class="script-action-form inline-form">
                                            <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                            <input type="hidden" name="simulation_id" value="{{ simulation_id }}">
                                            <input type="hidden"
                                                   name="current_simulation_id"
                                                   value="{{ simulation_id }}">
                                            <button type="submit"
                                                    class="danger"
                                                    {% if not allow_detach %}disabled{% endif %}>取消挂载</button>
                                        </form>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% elif simulation_id %}
                <div class="scroll-pane">
                    <p class="empty">尚未有脚本挂载。</p>
                </div>
            {% else %}
                <p class="empty">请选择或加入仿真世界后查看脚本列表。</p>
            {% endif %}
        </article>
        <article class="card">
            <h3>个人脚本库</h3>
            {% if user_scripts %}
                <div class="scroll-pane">
                    <ul class="script-list">
                        {% for script in user_scripts %}
                            <li>
                                <div class="script-item">
                                    <div class="script-detail">
                                        <span class="label">上传时间</span>
                                        <span class="value">{{ script.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</span>
                                        <span class="label">上传者</span>
                                        <span class="value">{{ script.user_id }}</span>
                                        <span class="label">脚本 ID</span>
                                        <span class="value">{{ script.script_id }}</span>
                                        <span class="label">版本</span>
                                        <span class="value">{{ script.code_version }}</span>
                                        <span class="label">状态</span>
                                        <span class="value">
                                            {% if script.simulation_id %}
                                                已挂载至 {{ script.simulation_id }}
                                            {% else %}
                                                未挂载
                                            {% endif %}
                                        </span>
                                    </div>
                                    {% if script.description %}
                                        <p class="script-desc">{{ script.description }}</p>
                                    {% else %}
                                        <p class="script-desc empty">（无描述）</p>
                                    {% endif %}
                                </div>
                                {% set script_tick = script_tick_map.get(script.simulation_id) %}
                                {% set detach_enabled = script.simulation_id and script_tick == 0 %}
                                {% set delete_enabled = (script.simulation_id is none) or (script_tick is none) or (script_tick == 0) %}
                                <div class="script-actions">
                                    <form method="post"
                                          action="/web/scripts/delete"
                                          class="script-action-form inline-form">
                                        <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                        <input type="hidden"
                                               name="current_simulation_id"
                                               value="{{ simulation_id }}">
                                        <button type="submit"
                                                class="danger"
                                                {% if not delete_enabled %}disabled{% endif %}>删除脚本</button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <div class="scroll-pane">
                    <p class="empty">还没有上传任何脚本，下面的表单可将脚本保存到个人脚本库。</p>
                </div>
            {% endif %}
        </article>
    </section>
    <section class="panel">
        <h3>上传脚本</h3>
        <form method="post"
              action="/web/scripts"
              class="script-form"
              enctype="multipart/form-data">
            <input type="hidden"
                   name="current_simulation_id"
                   value="{{ simulation_id }}">
            <label>
                脚本说明（可选）
                <input type="text" name="description" placeholder="简单描述脚本用途">
            </label>
            <label>
                脚本文件（仅支持 .py 扩展名）
                <input type="file" name="script_file" accept=".py" required>
            </label>
            <p class="form-hint">
                脚本必须定义 <code>generate_decisions(context)</code> 函数。
            </p>
            <p class="form-hint">若当前尚未加入仿真世界，脚本会先保存到个人脚本库，稍后可在下方挂载。</p>
            {% if simulation_id %}
                <p class="form-hint">
                    当前仿真世界：<strong>{{ simulation_id }}</strong>。新脚本会先保存到个人脚本库，您可以在下方选择挂载到该仿真世界。
                </p>
            {% endif %}
            <button type="submit">提交脚本</button>
        </form>
    </section>
    {% if simulation_id %}
        <section class="panel">
            <h3>挂载已有脚本</h3>
            {% if attachable_scripts %}
                <form method="post" action="/web/scripts/attach" class="script-form">
                    <input type="hidden" name="simulation_id" value="{{ simulation_id }}">
                    <label>
                        选择脚本
                        <select name="script_id">
                            {% for script in attachable_scripts %}
                                <option value="{{ script.script_id }}">
                                    {{ script.script_id }}
                                    {% if script.description %}· {{ script.description }}{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                    <p class="form-hint">将脚本挂载到当前仿真世界后，它会立即参与决策逻辑。</p>
                    <button type="submit">挂载脚本</button>
                </form>
            {% else %}
                <p class="empty">个人脚本库暂无未挂载的脚本。</p>
            {% endif %}
        </section>
    {% endif %}
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const storageKey = "userDashboardScrollY";
    window.history.scrollRestoration = "manual";

    const rememberScroll = () => {
        sessionStorage.setItem(
            storageKey,
            String(window.scrollY || window.pageYOffset || 0)
        );
    };

    const restoreScroll = () => {
        const stored = sessionStorage.getItem(storageKey);
        if (stored !== null) {
            const value = Number(stored);
            if (Number.isFinite(value)) {
                window.scrollTo({ top: value, behavior: "auto" });
            }
            sessionStorage.removeItem(storageKey);
        }
    };

    restoreScroll();

    document.querySelectorAll("form").forEach((form) => {
        form.addEventListener("submit", rememberScroll);
    });

    window.addEventListener("beforeunload", rememberScroll);
});
    </script>
{% endblock %}
