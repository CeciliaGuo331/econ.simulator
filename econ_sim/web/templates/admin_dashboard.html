{% extends "base.html" %}
{% from "partials/state_macros.html" import fmt_number, render_table, render_households_table %}
{% block title %}管理员仪表盘 - Econ Simulator{% endblock %}
{% block content %}
    {% set _tab = (active_tab if active_tab is defined and active_tab else 'overview') %}
    <nav class="tabs">
        {% set _base = "/web/dashboard" %}
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=overview"
           class="tab{% if _tab == 'overview' %} active{% endif %}">总览</a>
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=manage"
           class="tab{% if _tab == 'manage' %} active{% endif %}">世界管理</a>
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=users"
           class="tab{% if _tab == 'users' %} active{% endif %}">用户</a>
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=scripts"
           class="tab{% if _tab == 'scripts' %} active{% endif %}">脚本</a>
        <a href="{{ _base }}{% if simulation_id %}?simulation_id={{ simulation_id }}&{% else %}?{% endif %}tab=failures"
           class="tab{% if _tab == 'failures' %} active{% endif %}">失败事件</a>
    </nav>
    <section class="panel">
        <h2>管理员中心</h2>
        <p>
            当前仿真世界：<strong>{{ simulation_id }}</strong>
        </p>
        <p>
            当前单用户脚本数上限：
            {% if simulation_id %}
                {% if script_limit is not none %}
                    <strong>{{ script_limit }}</strong> 个脚本 / 用户
                {% elif default_script_limit is not none %}
                    <strong>{{ default_script_limit }}</strong> 个脚本 / 用户（默认）
                {% else %}
                    <strong>无限制</strong>
                {% endif %}
            {% else %}
                <span class="empty">未选择仿真世界</span>
            {% endif %}
        </p>
        <p>管理员账户可查看完整世界状态和所有脚本。</p>
        <div class="status success{% if not message %} hidden{% endif %}"
             data-status-box
             {% if not message %}style="display: none;"{% endif %}>{{ message or "" }}</div>
        <div class="error{% if not error %} hidden{% endif %}"
             data-error-box
             {% if not error %}style="display: none;"{% endif %}>{{ error or "" }}</div>
    </section>
    {% if log_download_url and (_tab == 'overview') %}
        <section class="panel">
            <h3>调试工具</h3>
            <p>选择仿真世界后，可以直接下载最近的执行日志，便于排查玩家脚本或系统状态。</p>
            <p>
                <a class="button" href="{{ log_download_url }}">下载最近日志</a>
            </p>
        </section>
    {% endif %}
    {% if _tab == 'failures' %}
        <section class="panel">
            <h3>脚本失败事件</h3>
            {% if script_failures %}
                <div class="scroll-pane">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>发生时间 (UTC)</th>
                                <th>脚本 ID</th>
                                <th>主体</th>
                                <th>用户</th>
                                <th>错误信息</th>
                                <th>详情</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for failure in script_failures %}
                                <tr>
                                    <td>{{ failure.occurred_at.strftime("%Y-%m-%d %H:%M:%S") }}</td>
                                    <td class="cell-id">{{ failure.script_id | e }}</td>
                                    <td>{{ failure.agent_kind.value | e }} / {{ failure.entity_id | e }}</td>
                                    <td>{{ failure.user_id | e }}</td>
                                    <td>{{ failure.message | e }}</td>
                                    <td>
                                        <details>
                                            <summary>查看</summary>
                                            <pre>{{ failure.traceback | e }}</pre>
                                        </details>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="empty">暂时没有脚本执行失败记录。</p>
            {% endif %}
        </section>
    {% endif %}
    {% if _tab == 'manage' %}
        <section class="panel">
            <h3>仿真世界管理</h3>
            <form method="post"
                  action="/web/admin/simulations/create"
                  class="admin-form">
                <input type="hidden"
                       name="current_simulation_id"
                       value="{{ simulation_id }}">
                <label>
                    新仿真世界 ID（留空自动生成）
                    <input type="text" name="simulation_id" placeholder="sim-2025">
                </label>
                <button type="submit">创建仿真世界</button>
            </form>
            <div class="scroll-pane">
                {% if all_simulations %}
                    <table class="admin-table">
                        <colgroup>
                            <col class="col-sim-id">
                            <col class="col-sim-households">
                            <col class="col-sim-limit">
                            <col class="col-sim-actions">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>仿真世界 ID</th>
                                <th class="household-header">挂载家户脚本数</th>
                                <th class="limit-header">单用户脚本数上限</th>
                                <th class="actions-header">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sid in all_simulations %}
                                <tr>
                                    <td>
                                        {% if sid == simulation_id %}
                                            <strong>{{ sid }}</strong>
                                        {% else %}
                                            <a href="/web/dashboard?simulation_id={{ sid }}"
                                               data-remember-scroll="true">{{ sid }}</a>
                                        {% endif %}
                                    </td>
                                    <td class="household-count">{{ household_counts_by_sim.get(sid, 0) }} 户</td>
                                    <td class="limit-cell">
                                        {% set limit = limits_by_sim.get(sid) %}
                                        <form method="post"
                                              action="/web/admin/simulations/script_limit"
                                              class="inline-form limit-form auto-run-form">
                                            <input type="hidden" name="simulation_id" value="{{ sid }}">
                                            <input type="hidden"
                                                   name="current_simulation_id"
                                                   value="{{ simulation_id }}">
                                            <label class="auto-run-input-wrap limit-input-wrap">
                                                <input type="number"
                                                       name="max_scripts_per_user"
                                                       min="1"
                                                       value="{{ limit if limit is not none else '' }}"
                                                       aria-label="脚本上限">
                                                <span class="auto-run-suffix limit-suffix">个</span>
                                            </label>
                                            <div class="limit-form-actions">
                                                <button type="submit"
                                                        class="auto-run-button"
                                                        name="submit_action"
                                                        value="apply">保存</button>
                                            </div>
                                        </form>
                                    </td>
                                    <td class="actions">
                                        {% set row_features = features_by_sim.get(sid) %}
                                        <div class="action-row primary-actions">
                                            <form method="post"
                                                  action="/web/admin/simulations/run"
                                                  class="inline-form"
                                                  data-async="true"
                                                  data-action-type="run-tick"
                                                  data-reload="true"
                                                  data-reload-delay="1200">
                                                <input type="hidden" name="simulation_id" value="{{ sid }}">
                                                <input type="hidden"
                                                       name="current_simulation_id"
                                                       value="{{ simulation_id }}">
                                                <button type="submit">执行 Tick</button>
                                            </form>
                                            <form method="post"
                                                  action="/web/admin/simulations/run_one_day"
                                                  class="inline-form auto-run-form"
                                                  data-async="true"
                                                  data-action-type="run-one-day"
                                                  data-reload="true"
                                                  data-reload-delay="1600">
                                                <input type="hidden" name="simulation_id" value="{{ sid }}">
                                                <input type="hidden"
                                                       name="current_simulation_id"
                                                       value="{{ simulation_id }}">
                                                <button type="submit" class="auto-run-button">执行 1 day</button>
                                                <label class="auto-run-input-wrap">
                                                    <input type="number"
                                                           name="ticks_per_day"
                                                           min="1"
                                                           value="{{ ticks_per_day_default }}"
                                                           placeholder="当日 Tick 数">
                                                    <span class="auto-run-suffix">ticks</span>
                                                </label>
                                                {% set remaining = remaining_ticks_by_sim.get(sid) %}
                                                {% if remaining is not none and remaining > 0 %}
                                                    <button type="button"
                                                            class="auto-run-button"
                                                            data-fill-remaining="{{ remaining }}">
                                                        补齐当日（剩余 {{ remaining }}）
                                                    </button>
                                                {% elif remaining == 0 %}
                                                    <span class="hint">已处于日终</span>
                                                {% endif %}
                                            </form>
                                            <form method="post"
                                                  action="/web/admin/simulations/reset"
                                                  class="inline-form">
                                                <input type="hidden" name="simulation_id" value="{{ sid }}">
                                                <button type="submit">重置</button>
                                            </form>
                                            <form method="post"
                                                  action="/web/admin/simulations/delete"
                                                  class="inline-form">
                                                <input type="hidden" name="simulation_id" value="{{ sid }}">
                                                <input type="hidden"
                                                       name="current_simulation_id"
                                                       value="{{ simulation_id }}">
                                                <button type="submit" class="danger">删除</button>
                                            </form>
                                        </div>
                                        <div class="action-row feature-actions">
                                            <form method="post"
                                                  action="/web/admin/simulations/features"
                                                  class="inline-form auto-run-form feature-form">
                                                <input type="hidden" name="simulation_id" value="{{ sid }}">
                                                <input type="hidden"
                                                       name="current_simulation_id"
                                                       value="{{ simulation_id }}">
                                                <button type="submit" class="auto-run-button">保存冲击</button>
                                                <label class="auto-run-input-wrap feature-toggle">
                                                    <input type="checkbox"
                                                           name="household_shock_enabled"
                                                           value="1"
                                                           {% if row_features and row_features.household_shock_enabled %}checked{% endif %}>
                                                    <span class="auto-run-suffix">启用</span>
                                                </label>
                                                <label class="auto-run-input-wrap">
                                                    <input type="number"
                                                           step="0.01"
                                                           min="0"
                                                           name="household_shock_ability_std"
                                                           value="{{ row_features.household_shock_ability_std if row_features else '' }}"
                                                           placeholder="σ能力">
                                                    <span class="auto-run-suffix">σ</span>
                                                </label>
                                                <label class="auto-run-input-wrap">
                                                    <input type="number"
                                                           step="0.01"
                                                           min="0"
                                                           name="household_shock_asset_std"
                                                           value="{{ row_features.household_shock_asset_std if row_features else '' }}"
                                                           placeholder="β资产">
                                                    <span class="auto-run-suffix">β</span>
                                                </label>
                                                <label class="auto-run-input-wrap">
                                                    <input type="number"
                                                           step="0.01"
                                                           min="0"
                                                           max="0.9"
                                                           name="household_shock_max_fraction"
                                                           value="{{ row_features.household_shock_max_fraction if row_features else '' }}"
                                                           placeholder="冲击上限">
                                                    <span class="auto-run-suffix">cash</span>
                                                </label>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty">尚未创建任何仿真世界。</p>
                {% endif %}
            </div>
        </section>
    {% endif %}
    {% if _tab == 'overview' %}
        <section class="grid">
            <article class="card wide">
                <h3>世界状态快照</h3>
                {% if context.world %}
                    {% set world = context.world %}
                    <div class="scroll-pane state-snapshot">
                        <div class="state-block">
                            <h4>仿真进度</h4>
                            {{ render_table([
                                                        ("仿真实例", world.simulation_id) ,
                            ("当前 Tick", world.tick, True),
                            ("当前日", world.day, True),
                            ("家户数量", world.households | length, True),
                            ("冲击条目", world.household_shocks | length if world.household_shocks is defined else 0, True)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>宏观指标</h4>
                            {{ render_table([
                                                        ("GDP", world.macro.gdp if world.macro is defined else None) ,
                            ("通胀率", world.macro.inflation if world.macro is defined else None),
                            ("失业率", world.macro.unemployment_rate if world.macro is defined else None),
                            ("物价指数", world.macro.price_index if world.macro is defined else None),
                            ("工资指数", world.macro.wage_index if world.macro is defined else None)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>企业主体</h4>
                            {{ render_table([
                                                        ("产品价格", world.firm.price if world.firm is defined else None) ,
                            ("计划产出", world.firm.planned_production if world.firm is defined else None),
                            ("工资报价", world.firm.wage_offer if world.firm is defined else None),
                            ("雇员数量", world.firm.employees | length if world.firm is defined else 0, True),
                            ("库存", world.firm.balance_sheet.inventory_goods if world.firm is defined else None),
                            ("现金", world.firm.balance_sheet.cash if world.firm is defined else None),
                            ("存款", world.firm.balance_sheet.deposits if world.firm is defined else None),
                            ("贷款", world.firm.balance_sheet.loans if world.firm is defined else None)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>商业银行</h4>
                            {{ render_table([
                                                        ("存款利率", world.bank.deposit_rate if world.bank is defined else None) ,
                            ("贷款利率", world.bank.loan_rate if world.bank is defined else None),
                            ("发放贷款数", world.bank.approved_loans | length if world.bank is defined else 0, True),
                            ("现金", world.bank.balance_sheet.cash if world.bank is defined else None),
                            ("存款", world.bank.balance_sheet.deposits if world.bank is defined else None),
                            ("贷款", world.bank.balance_sheet.loans if world.bank is defined else None)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>政府部门</h4>
                            {{ render_table([
                                                        ("税率", world.government.tax_rate if world.government is defined else None) ,
                            ("失业补贴", world.government.unemployment_benefit if world.government is defined else None),
                            ("财政支出", world.government.spending if world.government is defined else None),
                            ("雇员数量", world.government.employees | length if world.government is defined else 0, True),
                            ("现金", world.government.balance_sheet.cash if world.government is defined else None),
                            ("存款", world.government.balance_sheet.deposits if world.government is defined else None)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>中央银行</h4>
                            {{ render_table([
                                                        ("基准利率", world.central_bank.base_rate if world.central_bank is defined else None) ,
                            ("准备金率", world.central_bank.reserve_ratio if world.central_bank is defined else None),
                            ("通胀目标", world.central_bank.inflation_target if world.central_bank is defined else None),
                            ("失业目标", world.central_bank.unemployment_target if world.central_bank is defined else None)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>脚本功能开关</h4>
                            {{ render_table([
                                                        ("家户冲击启用", world.features.household_shock_enabled if world.features is defined else None) ,
                            ("能力冲击标准差", world.features.household_shock_ability_std if world.features is defined else None),
                            ("资产冲击标准差", world.features.household_shock_asset_std if world.features is defined else None),
                            ("冲击上限", world.features.household_shock_max_fraction if world.features is defined else None)
                            ]) }}
                        </div>
                        <div class="state-block">
                            <h4>家户样本（全部）</h4>
                            {# prefer the pre-sorted list if available #}
                            {% if world.households_list is defined %}
                                {{ render_households_table(world.households_list, -1) }}
                            {% else %}
                                {{ render_households_table(world.households, -1) }}
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <p class="empty">当前没有可展示的世界状态。</p>
                {% endif %}
            </article>
        </section>
    {% endif %}
    {% if _tab == 'users' %}
        <section class="panel">
            <h3>用户管理</h3>
            <div class="scroll-pane">
                {% if all_users %}
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>注册时间 (UTC)</th>
                                <th>脚本数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in all_users %}
                                <tr>
                                    <td>{{ item.email }}</td>
                                    <td>{{ item.user_type }}</td>
                                    <td>{{ item.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
                                    <td>{{ item.script_count }}</td>
                                    <td>
                                        {% if item.email == user.email %}
                                            <span class="hint">当前账号</span>
                                        {% else %}
                                            <form method="post" action="/web/admin/users/delete" class="inline-form">
                                                <input type="hidden" name="email" value="{{ item.email }}">
                                                <input type="hidden"
                                                       name="current_simulation_id"
                                                       value="{{ simulation_id }}">
                                                <button type="submit">删除</button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty">暂无注册用户。</p>
                {% endif %}
            </div>
        </section>
    {% endif %}
    {% if _tab == 'scripts' %}
        <section class="panel">
            <h3>脚本管理</h3>
            <div class="scroll-pane">
                {% if all_scripts %}
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>脚本 ID</th>
                                <th>版本号</th>
                                <th>仿真世界</th>
                                <th>用户</th>
                                <th>描述</th>
                                <th>上传时间 (UTC)</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for script in all_scripts %}
                                <tr>
                                    <td class="cell-id">{{ script.script_id }}</td>
                                    <td class="cell-id">{{ script.code_version }}</td>
                                    <td class="cell-simulation">
                                        {% if script.simulation_id %}
                                            {% if script.simulation_id == simulation_id %}
                                                <strong>{{ script.simulation_id }}</strong>
                                            {% else %}
                                                <a href="/web/dashboard?simulation_id={{ script.simulation_id }}"
                                                   data-remember-scroll="true">{{ script.simulation_id }}</a>
                                            {% endif %}
                                        {% else %}
                                            <span class="empty">未挂载</span>
                                        {% endif %}
                                    </td>
                                    <td class="cell-user">{{ script.user_id }}</td>
                                    <td class="cell-description">
                                        {% if script.description %}
                                            {{ script.description }}
                                        {% else %}
                                            <span class="empty">无</span>
                                        {% endif %}
                                    </td>
                                    <td class="cell-time">{{ script.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
                                    <td class="cell-actions">
                                        <form method="post" action="/web/admin/scripts/delete" class="inline-form">
                                            <input type="hidden"
                                                   name="simulation_id"
                                                   value="{{ script.simulation_id or '' }}">
                                            <input type="hidden" name="script_id" value="{{ script.script_id }}">
                                            <input type="hidden"
                                                   name="current_simulation_id"
                                                   value="{{ simulation_id }}">
                                            <button type="submit">删除</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty">暂时没有上传脚本。</p>
                {% endif %}
            </div>
        </section>
    {% endif %}
    <script>
document.addEventListener("DOMContentLoaded", () => {
    const successBox = document.querySelector("[data-status-box]");
    const errorBox = document.querySelector("[data-error-box]");
    const storageKeys = {
        message: "adminStatusMessage",
        type: "adminStatusType",
        scroll: "adminDashboardScrollY",
    };

    const rememberScroll = () => {
        sessionStorage.setItem(
            storageKeys.scroll,
            String(window.scrollY || window.pageYOffset || 0)
        );
    };

    const restoreScroll = () => {
        const stored = sessionStorage.getItem(storageKeys.scroll);
        if (stored !== null) {
            const value = Number(stored);
            if (Number.isFinite(value)) {
                window.scrollTo({ top: value, behavior: "auto" });
            }
            sessionStorage.removeItem(storageKeys.scroll);
        }
    };

    const showBox = (box, text) => {
        if (!box) {
            return;
        }
        const content = typeof text === "string" ? text.trim() : "";
        if (content) {
            box.textContent = content;
            box.classList.remove("hidden");
            box.style.removeProperty("display");
        } else {
            box.textContent = "";
            box.classList.add("hidden");
            box.style.display = "none";
        }
    };

    const showStatus = (text) => {
        showBox(errorBox, "");
        showBox(successBox, text);
    };

    const showError = (text) => {
        showBox(successBox, "");
        showBox(errorBox, text);
    };

    const persistMessage = (type, text) => {
        if (!text) {
            return;
        }
        sessionStorage.setItem(storageKeys.message, text);
        sessionStorage.setItem(storageKeys.type, type);
    };

    const restorePersistedMessage = () => {
        const text = sessionStorage.getItem(storageKeys.message);
        if (!text) {
            return;
        }
        const type = sessionStorage.getItem(storageKeys.type) || "success";
        if (type === "error") {
            showError(text);
        } else {
            showStatus(text);
        }
        sessionStorage.removeItem(storageKeys.message);
        sessionStorage.removeItem(storageKeys.type);
    };

    const clearFlashParams = () => {
        const url = new URL(window.location.href);
        let mutated = false;
        ["message", "error"].forEach((param) => {
            if (url.searchParams.has(param)) {
                url.searchParams.delete(param);
                mutated = true;
            }
        });
        if (mutated) {
            const query = url.searchParams.toString();
            const nextUrl = query ? `${url.pathname}?${query}` : url.pathname;
            window.history.replaceState({}, document.title, nextUrl);
        }
    };

    const buildReloadUrl = (simulationId) => {
        const url = new URL(window.location.href);
        if (simulationId) {
            url.searchParams.set("simulation_id", simulationId);
        }
        ["message", "error"].forEach((param) => url.searchParams.delete(param));
        const query = url.searchParams.toString();
        return query ? `${url.pathname}?${query}` : url.pathname;
    };

    restorePersistedMessage();
    restoreScroll();
    clearFlashParams();

    const jobPollers = new Map();

    const navigateWithRememberedScroll = (url) => {
        rememberScroll();
        window.location.assign(url);
    };

    const pollJobStatus = (
        jobId,
        { reloadDelay = 1400, simulationId = "", onFinally } = {}
    ) => {
        if (!jobId || jobPollers.has(jobId)) {
            return;
        }

        const cleanup = () => {
            const handle = jobPollers.get(jobId);
            if (handle) {
                window.clearInterval(handle);
                jobPollers.delete(jobId);
            }
            if (typeof onFinally === "function") {
                onFinally();
            }
        };

        const fetchStatus = async () => {
            try {
                const response = await fetch(`/web/admin/jobs/${jobId}`, {
                    headers: { Accept: "application/json" },
                });
                if (!response.ok) {
                    throw new Error(`status ${response.status}`);
                }
                const data = await response.json();
                const status = data.status;
                if (status === "queued" || status === "running") {
                    const progress =
                        data.message ||
                        `后台任务 ${jobId.slice(0, 8)}… 正在执行，请稍候…`;
                    showStatus(progress);
                    return false;
                }
                if (status === "succeeded") {
                    const message =
                        data.message ||
                        `后台任务 ${jobId.slice(0, 8)}… 已完成。`;
                    showStatus(message);
                    persistMessage("success", message);
                    const targetSimulation =
                        data.simulation_id || simulationId || "";
                    const delay = Number(reloadDelay);
                    window.setTimeout(() => {
                        navigateWithRememberedScroll(
                            buildReloadUrl(targetSimulation)
                        );
                    }, Number.isFinite(delay) ? delay : 1200);
                    return true;
                }
                if (status === "failed") {
                    const errorText =
                        data.error ||
                        `后台任务 ${jobId.slice(0, 8)}… 执行失败。`;
                    showError(errorText);
                    persistMessage("error", errorText);
                    return true;
                }
                showStatus(`后台任务 ${jobId.slice(0, 8)}… 状态：${status}`);
                return false;
            } catch (error) {
                showError("无法获取后台任务状态，请稍后重试。");
                return true;
            }
        };

        const poll = async () => {
            const finished = await fetchStatus();
            if (finished) {
                cleanup();
            }
        };

        const handle = window.setInterval(poll, 1000);
        jobPollers.set(jobId, handle);
        poll();
    };

    const forms = document.querySelectorAll("form[data-async='true']");
    forms.forEach((form) => {
        form.addEventListener("submit", async (event) => {
            event.preventDefault();

            const submitButton = form.querySelector("button[type='submit']");
            const originalLabel = submitButton ? submitButton.textContent : "";
            const simulationField = form.querySelector(
                "input[name='simulation_id']"
            );
            const daysField = form.querySelector("input[name='days']");
            const simId = simulationField ? simulationField.value.trim() : "";
            const daysValue = daysField ? daysField.value.trim() : "";
            const actionType = form.dataset.actionType || "action";

            if (submitButton) {
                submitButton.disabled = true;
                submitButton.classList.add("is-loading");
                submitButton.textContent = "执行中";
            }

            let pendingMessage = "操作进行中，请稍候...";
            if (actionType === "run-days") {
                pendingMessage = `正在执行仿真世界 ${
                    simId || "?"
                } 的 ${daysValue || "?"} day(s)，请稍候...`;
            } else if (simId) {
                pendingMessage = `正在执行仿真世界 ${simId}，请稍候...`;
            }
            showStatus(pendingMessage);

            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: form.method || "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "fetch",
                        Accept: "application/json",
                    },
                });

                const data = await response
                    .json()
                    .catch(() => ({ message: "", error: "" }));

                if (!response.ok) {
                    const errorText =
                        (data && data.error) || "操作失败，请稍后重试。";
                    showError(errorText);
                    if (data && data.job_id) {
                        pollJobStatus(data.job_id, {
                            simulationId: data.simulation_id || simId,
                            reloadDelay: Number(
                                form.dataset.reloadDelay || 1400
                            ),
                        });
                    }
                    persistMessage("error", errorText);
                } else {
                    const successText =
                        (data && data.message) || "操作完成。";
                    showStatus(successText);

                    if (data && data.job_id) {
                        pollJobStatus(data.job_id, {
                            simulationId: data.simulation_id || simId,
                            reloadDelay: Number(
                                form.dataset.reloadDelay || 1600
                            ),
                        });
                    } else if (form.dataset.reload === "true") {
                        const delay = Number(form.dataset.reloadDelay || 1200);
                        persistMessage("success", successText);
                        window.setTimeout(() => {
                            const targetSimulation =
                                data && data.simulation_id
                                    ? data.simulation_id
                                    : simId;
                            navigateWithRememberedScroll(
                                buildReloadUrl(targetSimulation)
                            );
                        }, Number.isFinite(delay) ? delay : 1200);
                    }
                }
            } catch (err) {
                showError("网络错误，稍后重试。");
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.classList.remove("is-loading");
                    submitButton.textContent = originalLabel;
                }
            }
        });
    });

    const syncForms = document.querySelectorAll("form:not([data-async='true'])");
    syncForms.forEach((form) => {
        form.addEventListener("submit", () => {
            rememberScroll();
        });
    });

    const scrollLinks = document.querySelectorAll("a[data-remember-scroll='true']");
    scrollLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
            if (
                event.defaultPrevented ||
                event.button !== 0 ||
                event.metaKey ||
                event.ctrlKey ||
                event.shiftKey ||
                event.altKey
            ) {
                return;
            }
            rememberScroll();
        });
    });

    // Quick-fill remaining ticks buttons
    document.querySelectorAll("button[data-fill-remaining]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
            const remaining = Number(btn.getAttribute("data-fill-remaining") || "");
            if (!Number.isFinite(remaining) || remaining <= 0) return;
            const form = btn.closest("form");
            if (!form) return;
            const input = form.querySelector("input[name='ticks_per_day']");
            if (!input) return;
            input.value = String(remaining);
            form.requestSubmit();
        });
    });
});
    </script>
{% endblock %}
