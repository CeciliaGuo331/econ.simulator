{% macro fmt_number(value) -%}
    {%- if value is none -%}
        <span class="empty">—</span>
    {%- elif value is boolean -%}
        {{ "是" if value else "否" }}
    {%- elif value is number -%}
        {{ "{:,.2f}".format(value) }}
    {%- else -%}
        {{ value }}
    {%- endif -%}
{%- endmacro %}
{% macro fmt_integer(value) -%}
    {%- if value is none -%}
        <span class="empty">—</span>
    {%- elif value is number -%}
        {{ "{:,.0f}".format(value) }}
    {%- else -%}
        {{ value }}
    {%- endif -%}
{%- endmacro %}
{% macro render_table(rows) -%}
    <table class="state-table">
        <tbody>
            {%- for row in rows %}
                {%- set label = row[0] -%}
                {%- set value = row[1] if row|length > 1 else None -%}
                {%- set as_int = row[2] if row|length > 2 else False -%}
                <tr>
                    <th>{{ label }}</th>
                    <td>
                        {%- if as_int -%}
                            {{ fmt_integer(value) }}
                        {%- else -%}
                            {{ fmt_number(value) }}
                        {%- endif -%}
                    </td>
                </tr>
            {%- endfor %}
        </tbody>
    </table>
{%- endmacro %}
{% macro render_households_table(households, limit=8) -%}
    {%- set ns = namespace(rows=[]) -%}
    {%- if households is mapping -%}
        {# iterate in insertion order so backend-supplied ordering is preserved #}
        {%- for hid, info in households.items() -%}
            {%- if limit < 0 or loop.index <= limit -%}
                {%- set ns.rows = ns.rows + [(hid, info)] -%}
            {%- endif -%}
        {%- endfor -%}
    {%- elif households is sequence -%}
        {# sequence may be either a list of info objects or a list of (id, info) pairs
           detect pairs by checking length/structure of first element #}
        {%- set _first = households[0] if households | length > 0 else None -%}
        {%- if _first is sequence and _first | length >= 2 -%}
            {%- for pair in households -%}
                {%- set hid = pair[0] -%}
                {%- set info = pair[1] -%}
                {%- if limit < 0 or loop.index <= limit -%}
                    {%- set ns.rows = ns.rows + [(hid, info)] -%}
                {%- endif -%}
            {%- endfor -%}
        {%- else -%}
            {%- for info in households -%}
                {%- if limit < 0 or loop.index <= limit -%}
                    {%- set hid = info.id if info.id is defined else (info["id"] if "id" in info else loop.index0) -%}
                    {%- set ns.rows = ns.rows + [(hid, info)] -%}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
    {%- endif -%}
    <table class="state-table">
        <thead>
            <tr>
                <th style="width:5%;">ID</th>
                <th style="width:8%;">现金</th>
                <th style="width:8%;">存款</th>
                <th style="width:5%;">负债</th>
                <th style="width:9%">国债持仓</th>
                <th style="width:5%;">技能</th>
                <th style="width:10%;">就业状态</th>
                <th style="width:8%;">教育状态</th>
                <th style="width:8%;">教育水平</th>
                <th style="width:8%;">劳动供给</th>
                <th style="width:8%;">工资收入</th>
                <th style="width:9%;">最新消费</th>
                <th style="width:9%;">累计效用</th>
            </tr>
        </thead>
        <tbody>
            {%- for hid, info in ns.rows -%}
                {%- set bs = info.balance_sheet if info.balance_sheet is defined else info["balance_sheet"] -%}
                <tr>
                    <td>{{ hid }}</td>
                    <td>{{ fmt_number(bs.cash if bs else None) }}</td>
                    <td>{{ fmt_number(bs.deposits if bs else None) }}</td>
                    <td>{{ fmt_number(bs.loans if bs else None) }}</td>
                    <td>
                        {%- set bh = (info.bond_holdings if info.bond_holdings is defined else (info["bond_holdings"] if "bond_holdings" in info else {})) -%}
                        {%- if bh and bh | length > 0 -%}
                            <small>
                            {%- for bid, qty in bh.items() -%}
                                {{ bid }}:{{ "{:.2f}".format(qty) }}{% if not loop.last %}, {% endif %}
                            {%- endfor -%}
                            </small>
                        {%- else -%}
                            <span class="empty">—</span>
                        {%- endif -%}
                    </td>
                    <td>{{ fmt_number(info.skill if info.skill is defined else info["skill"] if "skill" in info else None) }}</td>
                    <td>
                        {{ info.employment_status if info.employment_status is defined else info["employment_status"] if "employment_status" in info else "—" }}
                    </td>
                    <td>
                        {%- set studying = (info.is_studying if info.is_studying is defined else (info["is_studying"] if "is_studying" in info else False)) -%}
                        {%- if studying -%}
                            <span class="badge small">在学</span>
                        {%- else -%}
                            <span class="empty">否</span>
                        {%- endif -%}
                    </td>
                    <td>
                        {%- set edu_level = (info.education_level if info.education_level is defined else (info["education_level"] if "education_level" in info else None)) -%}
                        {{ fmt_number(edu_level) }}
                    </td>
                    <td>
                        {{ fmt_number(info.labor_supply if info.labor_supply is defined else info["labor_supply"] if "labor_supply" in info else None) }}
                    </td>
                    <td>
                        {{ fmt_number(info.wage_income if info.wage_income is defined else info["wage_income"] if "wage_income" in info else None) }}
                    </td>
                    <td>
                        {{ fmt_number(info.last_consumption if info.last_consumption is defined else info["last_consumption"] if "last_consumption" in info else None) }}
                    </td>
                    <td>
                        {{ fmt_number(info.lifetime_utility if info.lifetime_utility is defined else (info["lifetime_utility"] if "lifetime_utility" in info else None) ) }}
                    </td>
                </tr>
            {%- else -%}
                <tr>
                    <td colspan="13" class="empty">暂无家户数据。</td>
                </tr>
            {%- endfor -%}
        </tbody>
    </table>
{%- endmacro %}
